<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>음악 리스트</title>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eef2f3;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #4CAF50;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: bold;
        }

        button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        .playing {
            background-color: rgba(176, 204, 176, 0.8);
        }

        #controls {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        input[type="text"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .custom-audio {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px auto;
            max-width: 500px;
        }

        #playPause {
            margin-bottom: 10px;
        }

        #seekSlider {
            width: 100%;
        }

        #volumeControl {
            width: 100%;
            margin-top: 10px;
        }

        #timeDisplay {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>음악 리스트</h1>
    <table id="musicTable">
        <thead>
        <tr>
            <th>제목</th>
            <th>재생</th>
            <th>삭제</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="custom-audio">
        <audio id="audioPlayer"></audio>
        <button id="playPause">재생</button>
        <label for="seekSlider">재생 시간</label><input type="range" id="seekSlider" min="0" max="100" value="0" step="1">
        <div id="timeDisplay">00:00 / 00:00</div>
        <label for="volumeControl">볼륨</label><input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1">
        <div>
            <input type="checkbox" id="repeatCheckbox">
            <label for="repeatCheckbox">반복 재생</label>
        </div>
    </div>

    <div id="controls">
        <label for="artist">가수: </label>
        <input type="text" id="artist" placeholder="가수를 입력하세요">
        <label for="title">노래: </label>
        <input type="text" id="title" placeholder="노래 제목을 입력하세요">
        <button id="send">음악 추가</button>
    </div>

    <script>
        let musicList = [];
        let currentIndex = -1;
        let isPlaying = false;
        let savedTime = 0;
        let audioPlayer = document.getElementById('audioPlayer');
        let stompClient = null;
        let repeatEnabled = false;

        connect();

        document.getElementById("playPause").addEventListener("click", function() {
            if (musicList.length > 0) {
                if (!isPlaying) {
                    if (currentIndex === -1) {
                        currentIndex = 0;
                        playCurrentAudio();
                    } else {
                        audioPlayer.currentTime = savedTime;
                        audioPlayer.play();
                    }
                    isPlaying = true;
                    this.textContent = '일시정지';
                } else {
                    audioPlayer.pause();
                    savedTime = audioPlayer.currentTime;
                    isPlaying = false;
                    this.textContent = '재생';
                }
            }
        });

        document.getElementById("volumeControl").addEventListener("input", function() {
            audioPlayer.volume = this.value;
        });

        document.getElementById("seekSlider").addEventListener("input", function() {
            audioPlayer.currentTime = audioPlayer.duration * (this.value / 100);
        });

        audioPlayer.addEventListener("timeupdate", function() {
            updateSeekSlider();
            updateTimeDisplay();
        });

        audioPlayer.addEventListener("ended", function() {
            if (repeatEnabled) {
                playCurrentAudio(); // 반복 재생
            } else {
                playNextAudio(); // 다음 곡 재생
            }
        });

        document.getElementById("send").addEventListener("click", function() {
            if (document.getElementById("artist").value === '' && document.getElementById("title").value === '') {
                console.log("아티스트 이름과 노래 제목을 넣어주세요!");
            } else {
                sendMessage();
                document.getElementById("artist").value = '';
                document.getElementById("title").value = '';
            }
        });

        document.getElementById("repeatCheckbox").addEventListener("change", function() {
            repeatEnabled = this.checked;
        });

        function connect() {
            const socket = new SockJS('/wss');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('웹소켓에 연결되었습니다: ' + frame);
                stompClient.subscribe('/sub/message/{{id}}', function(message) {
                    const musicData = JSON.parse(message.body);
                    const exists = musicList.some(music => music.title === musicData.title);
                    if (!exists) {
                        addMusicToList(musicData);
                    }
                });
            });
        }

        function sendMessage() {
            stompClient.send("/app/message/{{id}}", {}, JSON.stringify({
                artist: document.getElementById("artist").value,
                title: document.getElementById("title").value
            }));
        }

        function addMusicToList(musicData) {
            musicList.push(musicData);
            updateMusicTable();
            if (musicList.length === 1) {
                playCurrentAudio();
                document.getElementById("playPause").textContent = '일시정지';
            }
        }

        function updateMusicTable() {
            const tbody = document.getElementById('musicTable').querySelector('tbody');
            tbody.innerHTML = '';

            musicList.forEach((musicData, index) => {
                const row = document.createElement('tr');
                const titleCell = document.createElement('td');
                const buttonCell = document.createElement('td');
                const deleteCell = document.createElement('td');

                titleCell.textContent = musicData.title;

                const playButton = document.createElement('button');
                playButton.textContent = '재생';
                playButton.onclick = () => playAudio(index);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = '삭제';
                deleteButton.onclick = () => {
                    fetch(`/delete/{{id}}/${musicData.title}`, { method: 'DELETE' }).then(response => {
                        if (response.ok) {
                            console.log("삭제되었습니다.");
                            handleMusicDelete(index);
                        }
                    });
                };

                buttonCell.appendChild(playButton);
                deleteCell.appendChild(deleteButton);
                row.appendChild(titleCell);
                row.appendChild(buttonCell);
                row.appendChild(deleteCell);
                tbody.appendChild(row);
            });
            highlightCurrentRow(); // 현재 곡 강조 유지
        }

        function handleMusicDelete(index) {
            if (musicList.length === 0) {
                audioPlayer.pause(); // 모든 곡이 삭제되면 음악 멈춤
                isPlaying = false;
                document.getElementById("playPause").textContent = '재생';
                currentIndex = -1; // 인덱스 초기화
            } else {
                if (index === currentIndex) {
                    musicList.splice(index, 1); // 현재 곡 삭제
                    if (musicList.length === 0) {
                        audioPlayer.pause(); // 모든 곡이 삭제되면 음악 멈춤
                        isPlaying = false;
                        document.getElementById("playPause").textContent = '재생';
                        currentIndex = -1; // 인덱스 초기화
                    } else {
                        // 삭제한 곡이 마지막 곡인 경우
                        if (currentIndex === musicList.length) {
                            currentIndex = 0; // 처음 곡으로 돌아감
                        }
                        playCurrentAudio(); // 다음 곡 재생
                    }
                } else {
                    musicList.splice(index, 1); // 리스트에서 곡 삭제
                    if (index < currentIndex) {
                        currentIndex--; // 삭제한 곡이 현재 곡 인덱스보다 앞에 있을 경우 인덱스 조정
                    }
                }
            }
            updateMusicTable();
        }

        function playAudio(index) {
            currentIndex = index;
            playCurrentAudio();
        }

        function playCurrentAudio() {
            if (currentIndex >= 0 && currentIndex < musicList.length) {
                const musicData = musicList[currentIndex];
                const byteCharacters = atob(musicData.musicFileBytes);
                const byteNumbers = new Uint8Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const blob = new Blob([byteNumbers], { type: 'audio/mpeg' });
                const url = URL.createObjectURL(blob);
                audioPlayer.src = url;
                audioPlayer.play();
                isPlaying = true;
                document.getElementById("playPause").textContent = '일시정지';
                highlightCurrentRow(); // 현재 곡 강조
            }
        }

        function playNextAudio() {
            currentIndex++;
            if (currentIndex < musicList.length) {
                playCurrentAudio();
            } else {
                currentIndex = 0; // 반복 재생 시 첫 곡으로 돌아감
                playCurrentAudio();
            }
        }

        function highlightCurrentRow() {
            const rows = document.querySelectorAll('#musicTable tbody tr');
            rows.forEach((row, index) => {
                if (index === currentIndex) {
                    row.classList.add('playing');
                } else {
                    row.classList.remove('playing');
                }
            });
        }

        // 음악 리스트 초기화 및 갱신
        function list() {
            fetch("/list/{{id}}")
                .then(response => response.json())
                .then(data => {
                    musicList = data;
                    updateMusicTable();
                });
        }

        // Seek 슬라이더 업데이트
        function updateSeekSlider() {
            const seekSlider = document.getElementById('seekSlider');
            if (audioPlayer.duration > 0) {
                seekSlider.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            }
        }

        // 시간 표시 업데이트
        function updateTimeDisplay() {
            const timeDisplay = document.getElementById('timeDisplay');
            const currentTime = formatTime(audioPlayer.currentTime);
            const duration = formatTime(audioPlayer.duration);
            timeDisplay.textContent = `${currentTime} / ${duration}`;
        }

        // 시간 포맷팅
        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00'; // NaN 처리
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        list();
    </script>
</body>
</html>